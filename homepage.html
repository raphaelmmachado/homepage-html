<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pagina Inicial</title>
    <link
      rel="icon"
      type="image/svg+xml"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24' fill='white' stroke='%23000' stroke-width='0.9' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M5 12l-2 0l9 -9l9 9l-2 0'/%3E%3Cpath d='M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7'/%3E%3Cpath d='M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6'/%3E%3C/svg%3E"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      /* Estilo para garantir que o input de edição tenha a mesma aparência do título */
      .title-input {
        background: transparent;
        border: none;
        outline: none;
        padding: 0;
        margin: 0;
        width: 100%;
      }
      /* Estilos para o drag and drop */
      .dragging {
        opacity: 0.5;
      }
      .drag-over {
        border: 2px dashed #3b82f6; /* Borda azul para indicar o local de soltar */
      }
    </style>
  </head>
  <body class="bg-gray-100 text-gray-800 flex flex-col min-h-screen">
    <div id="app" class="container mx-auto p-4 md:p-8 max-w-7xl flex-grow">
      <header class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-900">Pagina Inicial</h1>
        <p class="text-gray-600 mt-2">Suas categorias de sites importantes.</p>

        <div class="mt-6 w-full max-w-lg mx-auto">
          <input
            type="search"
            id="search-bar"
            placeholder="Pesquisar favoritos..."
            class="w-full px-4 py-2 border border-gray-300 rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
      </header>

      <div
        id="containers-wrapper"
        class="flex flex-wrap gap-6 justify-center md:justify-start"
      >
        <!-- As categorias e o botão de adicionar serão inseridos aqui -->
      </div>
    </div>

    <!-- ALTERAÇÃO: Removido 'sticky bottom-0' do footer -->
    <footer class="bg-white p-4 mt-8 border-t border-gray-200">
      <div class="container mx-auto flex justify-center items-center gap-4">
        <button
          id="import-btn"
          class="bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-700 transition-colors"
        >
          Importar Favoritos
        </button>
        <button
          id="export-btn"
          class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition-colors"
        >
          Salvar Favoritos
        </button>
      </div>
      <input type="file" id="import-file-input" class="hidden" accept=".json" />
    </footer>

    <!-- Modal para adicionar favorito (sem alterações) -->
    <div
      id="add-bookmark-dialog"
      class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden"
    >
      <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-4">
        <h3 class="text-xl font-semibold mb-4">Adicionar Novo Favorito</h3>
        <form id="add-bookmark-form">
          <div class="mb-4">
            <label
              for="bookmark-name"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Nome do Site</label
            >
            <input
              type="text"
              id="bookmark-name"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Ex: Google"
            />
          </div>
          <div class="mb-6">
            <label
              for="bookmark-url"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Link (URL)</label
            >
            <input
              type="text"
              id="bookmark-url"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Ex: google.com"
            />
          </div>
          <div class="flex justify-end space-x-3">
            <button
              type="button"
              id="cancel-add-bookmark-btn"
              class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700"
            >
              Salvar
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- ESTADO E CHAVES DO LOCALSTORAGE ---
        let containers = [];
        let bookmarks = [];
        let activeContainerId = null;
        let draggedContainerId = null;

        const bookmarksStorageKey = "my-homepage-bookmarks-v2";
        const containersStorageKey = "my-homepage-containers-v2";

        // --- ELEMENTOS DO DOM ---
        const containersWrapper = document.getElementById("containers-wrapper");
        const dialog = document.getElementById("add-bookmark-dialog");
        const dialogForm = document.getElementById("add-bookmark-form");
        const cancelBtn = document.getElementById("cancel-add-bookmark-btn");
        const searchBar = document.getElementById("search-bar");
        const importBtn = document.getElementById("import-btn");
        const exportBtn = document.getElementById("export-btn");
        const importFileInput = document.getElementById("import-file-input");

        // --- FUNÇÕES DE LÓGICA ---

        const saveData = () => {
          localStorage.setItem(
            containersStorageKey,
            JSON.stringify(containers)
          );
          localStorage.setItem(bookmarksStorageKey, JSON.stringify(bookmarks));
        };

        const loadData = () => {
          const savedContainers = localStorage.getItem(containersStorageKey);
          const savedBookmarks = localStorage.getItem(bookmarksStorageKey);

          containers = savedContainers
            ? JSON.parse(savedContainers)
            : [{ id: crypto.randomUUID(), title: "Categoria" }];
          bookmarks = savedBookmarks ? JSON.parse(savedBookmarks) : [];
        };

        const render = (searchTerm = "") => {
          const lowerCaseSearchTerm = searchTerm.toLowerCase();
          containersWrapper.innerHTML = "";

          containers.forEach((container) => {
            const containerBookmarks = bookmarks.filter(
              (b) =>
                b.containerId === container.id &&
                b.name.toLowerCase().includes(lowerCaseSearchTerm)
            );

            if (!lowerCaseSearchTerm || containerBookmarks.length > 0) {
              containersWrapper.appendChild(
                createContainerElement(container, containerBookmarks)
              );
            }
          });

          if (containersWrapper.innerHTML === "" && lowerCaseSearchTerm) {
            containersWrapper.innerHTML = `<p class="text-center text-gray-500 w-full">Nenhum favorito encontrado para "${searchTerm}".</p>`;
          }

          if (!lowerCaseSearchTerm) {
            containersWrapper.appendChild(createAddCategoryBox());
          }
        };

        // --- FUNÇÕES DE CRIAÇÃO DE ELEMENTOS ---

        const createBookmarkElement = (bookmark) => {
          const faviconUrl = `https://www.google.com/s2/favicons?sz=64&domain_url=${bookmark.url}`;
          const fallbackIcon = `data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM5YWEzYjgiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSIxMCIvPjxsaW5lIHgxPSIyIiB5MT0iMTIiIHgyPSIyMiIgeTI9IjEyIi8+PHBhdGggZD0iTTEyIDJhMTUuMyAxNS4zIDAgMCAxIDQgMTAgMTUuMyAxNS4zIDAgMCAxLTQgMTAgMTUuMyAxNS4zIDAgMCAxLTQtMTAgMTUuMyAxNS4zIDAgMCAxIDQtMTAgeiIvPjwvc3ZnPg==`;

          const element = document.createElement("div");
          element.className = "relative flex flex-col items-center group";

          element.innerHTML = `
                    <a href="${bookmark.url}" target="_blank" rel="noopener noreferrer" class="flex flex-col items-center p-2 rounded-lg hover:bg-gray-200 transition-colors duration-200 w-full">
                        <img src="${faviconUrl}" alt="Ícone de ${bookmark.name}" class="w-10 h-10 object-contain mb-2 rounded-md shadow-sm" onerror="this.onerror=null; this.src='${fallbackIcon}'; this.classList.add('p-3', 'bg-gray-200');" />
                        <span class="text-sm font-medium text-gray-700 break-words text-center w-full px-1">${bookmark.name}</span>
                    </a>
                    <button class="remove-bookmark-btn absolute top-0 right-0 w-4 h-4 bg-red-500 text-white rounded-full flex items-center justify-center text-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 hover:bg-red-600 focus:opacity-100" aria-label="Remover ${bookmark.name}">
                        &times;
                    </button>
                `;

          element
            .querySelector(".remove-bookmark-btn")
            .addEventListener("click", () => {
              bookmarks = bookmarks.filter((b) => b.id !== bookmark.id);
              saveData();
              render(searchBar.value);
            });

          return element;
        };

        const createContainerElement = (container, containerBookmarks) => {
          const element = document.createElement("div");
          element.className =
            "bg-gray-50 p-4 rounded-lg shadow-md relative group transition-all";
          element.setAttribute("draggable", "true");
          element.dataset.id = container.id;

          element.addEventListener("dragstart", (e) => {
            draggedContainerId = container.id;
            setTimeout(() => e.target.classList.add("dragging"), 0);
          });
          element.addEventListener("dragend", (e) =>
            e.target.classList.remove("dragging")
          );
          element.addEventListener("dragover", (e) => {
            e.preventDefault();
            e.target.closest(".group").classList.add("drag-over");
          });
          element.addEventListener("dragleave", (e) =>
            e.target.closest(".group").classList.remove("drag-over")
          );
          element.addEventListener("drop", (e) => {
            e.preventDefault();
            e.target.closest(".group").classList.remove("drag-over");
            if (draggedContainerId === container.id) return;
            const draggedIndex = containers.findIndex(
              (c) => c.id === draggedContainerId
            );
            const targetIndex = containers.findIndex(
              (c) => c.id === container.id
            );
            const [draggedItem] = containers.splice(draggedIndex, 1);
            containers.splice(targetIndex, 0, draggedItem);
            saveData();
            render(searchBar.value);
          });

          const header = document.createElement("div");
          header.className = "flex justify-between items-center mb-4";

          const titleElement = document.createElement("h2");
          titleElement.className =
            "text-xl font-bold text-gray-800 cursor-pointer flex-grow";
          titleElement.textContent = container.title;

          titleElement.addEventListener("click", () => {
            const input = document.createElement("input");
            input.type = "text";
            input.value = container.title;
            input.className = "text-xl font-bold text-gray-800 title-input";
            const saveEdit = () => {
              const newTitle = input.value.trim();
              if (newTitle) container.title = newTitle;
              saveData();
              render(searchBar.value);
            };
            input.addEventListener("blur", saveEdit);
            input.addEventListener("keydown", (e) => {
              if (e.key === "Enter") input.blur();
              if (e.key === "Escape") render(searchBar.value);
            });
            titleElement.replaceWith(input);
            input.focus();
            input.select();
          });

          const removeContainerBtn = document.createElement("button");
          removeContainerBtn.className =
            "absolute top-3 right-3 w-7 h-7 bg-gray-300 text-gray-600 rounded-full flex items-center justify-center text-lg opacity-0 group-hover:opacity-100 transition-all duration-200 hover:bg-red-500 hover:text-white";
          removeContainerBtn.innerHTML = "&times;";
          removeContainerBtn.ariaLabel = `Remover categoria ${container.title}`;
          removeContainerBtn.addEventListener("click", () => {
            if (
              confirm(
                `Tem certeza que deseja remover a categoria "${container.title}" e todos os seus favoritos?`
              )
            ) {
              containers = containers.filter((c) => c.id !== container.id);
              bookmarks = bookmarks.filter(
                (b) => b.containerId !== container.id
              );
              saveData();
              render(searchBar.value);
            }
          });

          header.appendChild(titleElement);
          element.appendChild(removeContainerBtn);

          const grid = document.createElement("div");
          grid.className = "flex flex-wrap gap-x-4 gap-y-6";

          containerBookmarks.forEach((bookmark) =>
            grid.appendChild(createBookmarkElement(bookmark))
          );

          const addBookmarkBox = document.createElement("div");
          let classString =
            "flex flex-col items-center justify-center p-2 cursor-pointer group transition-opacity duration-300";
          if (containerBookmarks.length > 0)
            classString += " opacity-0 group-hover:opacity-100";

          addBookmarkBox.className = classString;
          addBookmarkBox.innerHTML = `
                    <div class="flex items-center justify-center w-10 h-10 rounded-md border-2 border-dashed border-gray-400 text-gray-400 group-hover:bg-gray-200 group-hover:text-gray-600 group-hover:border-gray-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </div>
                    <span class="mt-2 text-sm font-medium text-gray-700">Adicionar</span>
                `;
          addBookmarkBox.addEventListener("click", () => {
            activeContainerId = container.id;
            dialog.classList.remove("hidden");
            document.getElementById("bookmark-name").focus();
          });
          grid.appendChild(addBookmarkBox);

          element.appendChild(header);
          element.appendChild(grid);
          return element;
        };

        const createAddCategoryBox = () => {
          const addContainerBox = document.createElement("div");
          addContainerBox.className =
            "bg-gray-50/50 border-2 border-dashed border-gray-300 p-4 rounded-lg hover:bg-gray-50 transition-colors flex items-center justify-center cursor-pointer min-h-[148px]";

          const addTitle = document.createElement("h2");
          addTitle.className = "text-xl font-bold text-gray-500 text-center";
          addTitle.textContent = "+ Criar Categoria";

          addContainerBox.addEventListener("click", () => {
            const input = document.createElement("input");
            input.type = "text";
            input.placeholder = "Nome da Nova Categoria";
            input.className =
              "text-xl font-bold text-gray-800 title-input text-center";

            const saveNew = () => {
              const title = input.value.trim();
              if (title) {
                containers.push({ id: crypto.randomUUID(), title });
                saveData();
              }
              render();
            };

            input.addEventListener("blur", saveNew);
            input.addEventListener("keydown", (e) => {
              if (e.key === "Enter") input.blur();
              if (e.key === "Escape") render();
            });

            addContainerBox.innerHTML = "";
            addContainerBox.appendChild(input);
            input.focus();
          });

          addContainerBox.appendChild(addTitle);
          return addContainerBox;
        };

        // --- MANIPULADORES DE EVENTOS ---

        searchBar.addEventListener("input", (e) => render(e.target.value));

        dialogForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const name = document.getElementById("bookmark-name").value.trim();
          const url = document.getElementById("bookmark-url").value.trim();
          if (name && url && activeContainerId) {
            const cleanedUrl = url
              .replace(/^(?:https?:\/\/)?/i, "")
              .replace(/^www\./i, "");
            const finalUrl = "https://" + cleanedUrl;
            bookmarks.push({
              id: crypto.randomUUID(),
              name,
              url: finalUrl,
              containerId: activeContainerId,
            });
            saveData();
            render(searchBar.value);
            dialogForm.reset();
            dialog.classList.add("hidden");
            activeContainerId = null;
          }
        });

        cancelBtn.addEventListener("click", () => {
          dialogForm.reset();
          dialog.classList.add("hidden");
          activeContainerId = null;
        });

        dialog.addEventListener("click", (e) => {
          if (e.target === dialog) cancelBtn.click();
        });

        exportBtn.addEventListener("click", () => {
          const dataStr = JSON.stringify({ containers, bookmarks }, null, 2);
          const dataBlob = new Blob([dataStr], { type: "application/json" });
          const url = URL.createObjectURL(dataBlob);
          const link = document.createElement("a");
          link.href = url;
          link.download = "meus_favoritos_backup.json";
          link.click();
          URL.revokeObjectURL(url);
        });

        importBtn.addEventListener("click", () => importFileInput.click());

        importFileInput.addEventListener("change", (e) => {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const data = JSON.parse(event.target.result);
              if (
                data &&
                Array.isArray(data.containers) &&
                Array.isArray(data.bookmarks)
              ) {
                if (
                  confirm(
                    "Isso irá substituir todos os seus favoritos e categorias atuais. Deseja continuar?"
                  )
                ) {
                  containers = data.containers;
                  bookmarks = data.bookmarks;
                  saveData();
                  render();
                }
              } else {
                alert("Arquivo de backup inválido.");
              }
            } catch (error) {
              alert(
                "Erro ao ler o arquivo. Certifique-se de que é um backup válido."
              );
              console.error("Erro na importação:", error);
            }
          };
          reader.readAsText(file);
          e.target.value = ""; // Limpa o input para permitir importar o mesmo arquivo novamente
        });

        // --- INICIALIZAÇÃO ---
        loadData();
        render();
      });
    </script>
  </body>
</html>
